services:

  ollama:
    image: elebosc/ollama-gguf  # Docker Swarm requires to specify the image used even if it is already specified in the Dockerfile
    build:
      context: .
      dockerfile: ./Dockerfile.ollama
    hostname: ollama
    ports:
      - 11434:11434   # port 11434 of the host is mapped to port 11434 of the container
    healthcheck: 
      test: "bash -c 'cat < /dev/null > /dev/tcp/localhost/11434'"
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - rag-backend-net
    deploy:
      mode: global
      placement:
        constraints:
        - node.hostname == ollama-vm
  
  chroma:
    image: chromadb/chroma
    hostname: chroma
    ports:
      - 8000:8000   # port 8000 of the host is mapped to port 8000 of the container
    healthcheck:
      test: "bash -c 'cat < /dev/null > /dev/tcp/localhost/8000'"
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - rag-backend-net
    deploy:
      mode: global
      placement:
        constraints:
        - node.hostname == frontend-chroma-vm

networks:
  rag-backend-net:
    name: rag-backend-net
    external: true
